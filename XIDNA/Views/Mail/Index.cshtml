@*@model XICore.XIIOServerDetails*@
@{
    Layout = "~/Views/Shared/_PopupLayout.cshtml";
    string PhysicalPath = System.Configuration.ConfigurationManager.AppSettings["PhysicalPath"];
}
<script src="~/Scripts/jquery.blockUI.js"></script>
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.1.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>


<style>
    .folders {
        margin-bottom: 7px;
        width: 100%;
        text-align: left;
        padding: 2px 12px;
        background: #6bba70;
    }

    folders .folders:hover {
        background: #29bd32 !important;
        border: 1px solid #29bd32 !important;
    }

    #MailData table {
        color: #000 !important;
    }
</style>
<section class="content-header hedr">
    <h1> Mails </h1>
    <div class="form-group col-md-3" id="MailIDs">
        @*<label for="inputEmail" class="gn">Organization<span class="danger">*</span></label>*@
        @*@Html.DropDownListFor(m => m.mail, new SelectList(Model.MailIDs, "Value", "text"), "--Select Mail ID--", new { @class = "form-control", @id = "MailID" })*@
        <select id="MailID" class="form-control">
            <option value="">Please Select</option>
            @foreach (var item in Model.MailIDs)
            {
                <option value="@item.Value">@item.text</option>
            }
        </select>

    </div>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Mails</a></li>
        <li class="active">Home</li>
    </ol>
</section>
<div id="messages"></div>
<div class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-primary">
                <div class="row">
                    <div class="col-xs-12 tree_btn">
                        <div id="Import">
                            <h4><button class="btn maillist btn-xs visible-xs">Menu</button><span class="EMailID"></span></h4>
                            @*<button class="savebtn btn btn-primary btn2 pull-right" type="submit" id="ImportEmail">Import Email</button>*@

                        </div>
                        @* Emails display *@
                        <div id="EmailBox">
                            <div id="FolderList">
                                @* Display folders *@
                            </div>
                            <div id="SubjectList" class="fullwidth table-clean">
                                @* Display subject *@
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="content" id="SuccessTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="MailData" class="dialog-box" title="Confirm Message" style="background-color:red;"></div>
</div>
<script>
    $(document.body).on('click', 'button#folderName', function () {
        $.blockUI({ message: '<h3 class="nh3"><img src="@PhysicalPath/Scripts/ckfinder/plugins/gallery/colorbox/images/loading.gif" width="50px" /> Please wait while loading mails...</h3>' });
        var sSelectedFolder = $(this).attr("value");
        var ID = $('#MailID :selected').val();
        var sValues = { sFolder: sSelectedFolder, ID: ID };
        $.ajax({
            url: '@Url.Action("GetSubjectWithIMAP", "Mail")',
            type: 'POST',
            datatype: 'JSON',
            contentType: "application/json; charset=utf-8",
            cache: false,
            data: JSON.stringify(sValues),
            success: function (data) {//SubjectList
                var Mails = "";
                Mails = "<table class='table table-striped custom-table dark-head dark-head2 table-condensed' id='MailLeadGrid'><thead><tr><th>From</th><th>Subject</th><th>Date</th></tr></thead><tbody>";
                for (i = 0; i < data.length; i++) {
                    var sSubjectDetails = data[i];
                    var sDetailsSplit = sSubjectDetails.split(" <> ");
                    var iUID = sDetailsSplit[0];
                    var sFolder = sDetailsSplit[1];
                    var sSubject = sDetailsSplit[2];
                    var sFromName = sDetailsSplit[3];
                    var sDate = sDetailsSplit[4];
                    Mails = Mails + "<tr class='SubjectClick' id='" + iUID + "-" + sFolder + "' style='color:red'><td>" + sFromName + "</td><td>" + sSubject + "</td><td>" + sDate + "</td></tr></div>";
                }
                Mails = Mails + "</tbody></table>";
                $("#SubjectList").html(Mails);
                //$('#MailLeadGrid').dataTable();
                $.unblockUI();
            }
        });
    });

    $(document.body).on('click', 'tr.SubjectClick', function () {
        $.blockUI({ message: '<h3 class="nh3"><img src="@PhysicalPath/Scripts/ckfinder/plugins/gallery/colorbox/images/loading.gif" width="50px" /> Please wait while showing mail content...</h3>' });
        var sSelectedID = $(this).attr("id");
        var sSubjectSplit = sSelectedID.split("-");
        var ID = $('#MailID :selected').val();
        var iUID = sSubjectSplit[0];
        var sFolder = sSubjectSplit[1];
        var sValues = { iUID: iUID, sFolder: sFolder, ID: ID };
        $.ajax({
            url: '@Url.Action("GetEmailDetailsByUID", "Mail")',
            type: 'POST',
            datatype: 'JSON',
            contentType: "application/json; charset=utf-8",
            cache: false,
            data: JSON.stringify(sValues),
            success: function (data) {
                $("#MailData").empty();
               // for (i = 0; i < data.length; i++) {
                    var sEmailDetails = data;
                    var sDetailsSplit = sEmailDetails.split(" <> ");
                    var sFrom = sDetailsSplit[0];
                    var sSubject = sDetailsSplit[1];
                    var sText = sDetailsSplit[2];
                    var sHtml = sDetailsSplit[3];
                    var sAttachment = sDetailsSplit[4];
                    if (sHtml.length > 0) {
                        // $("#MailData").append("From: " + sFrom + "<br/>Subject: " + sSubject + "<br/>Message: <br/>" + sHtml + "<br/>" + sAttachment + "<br/>");
                        $("#MailData").append("From: " + sFrom + "<br/>Subject: " + sSubject + "<br/>Body: " + sText + "<br/>" + sAttachment + "<br/>");
                    }
                    else {
                        $("#MailData").append("From: " + sFrom + "<br/>Subject: " + sSubject + "<br/>Body: " + sText + "<br/>" + sAttachment + "<br/>");
                    }
                    //$("#MailData").append("From: " + sFrom + "<br/>");
                    //$("#MailData").append("Subject: " + sSubject + "<br/>");
                    ////$("#MailData").append("Body: "+sText + "<br/>");
                    //if (sHtml.length > 0) {
                    //    $("#MailData").append("Message: <br/>" + sHtml + "<br/>");
                    //}
                    //else {
                    //    $("#MailData").append("Message: <br/>" + sText + "<br/>");
                    //}

                    //$("#MailData").append(sAttachment + "<br/>");
              //  }
                $("#MailData").dialog({
                    open: function () {
                        $(this).scrollTop(0);
                    },
                    autoOpen: true,
                    modal: true,
                    title: 'Mail Content',
                    width: 800,
                    buttons: {
                        Save: function () {
                            //Save to DB
                            $.blockUI({ message: '<h3 class="nh3"><img src="@PhysicalPath/Scripts/ckfinder/plugins/gallery/colorbox/images/loading.gif" width="50px" /> Please wait while saving data...</h3>' });
                            var sValues = { iUID: iUID, sFolder: sFolder, ID: ID };
                            $.ajax({
                                url: '@Url.Action("SaveSelectedEmailByUID", "Mail")',
                                type: 'POST',
                                datatype: 'JSON',
                                contentType: "application/json; charset=utf-8",
                                cache: false,
                                data: JSON.stringify(sValues),
                                success: function (data) {
                                    if (data == "Success") {
                                        $("#MailData").html('Mail saved successfully');
                                        $("#MailData").dialog({
                                            autoOpen: true,
                                            modal: true,
                                            title: 'Mail',
                                            width: 450,
                                            buttons: {
                                                Ok: function () {
                                                    $(this).dialog("close"); //closing on Ok click
                                                },
                                            },

                                        });
                                    }
                                    else if (data == "Failure") {
                                        $("#MailData").html("Unable to extract data. Please check format & try again");
                                        $("#MailData").dialog({
                                            autoOpen: true,
                                            modal: true,
                                            title: 'No Data',
                                            width: 400,
                                            buttons: {
                                                Ok: function () {
                                                    $(this).dialog("close"); //closing on Ok click
                                                },
                                            },

                                        });
                                    }
                                    else if (data == "Lead Already Saved") {
                                        $("#MailData").html("Lead Already Saved");
                                        $("#MailData").dialog({
                                            autoOpen: true,
                                            modal: true,
                                            title: 'Lead Details',
                                            width: 400,
                                            buttons: {
                                                Ok: function () {
                                                    $(this).dialog("close"); //closing on Ok click
                                                },
                                            },

                                        });
                                    }
                                    else {
                                        var sTable = "";
                                        sTable = sTable + "<table class='table table-striped custom-table dark-head dark-head2 table-condensed' id='LeadDataTable1'><thead><tr><th style='display:none'>ID</th><th>Title</th><th>First Name</th><th>Last Name</th><th>Mobile Number</th><th>Email</th><th>DOB</th><th>PostCode</th></tr></thead>";
                                        for (i = 1; i < data.length; i++) {
                                            sTable = sTable + "<tr>";
                                            for (j = 0; j < data[i].length; j++) {
                                                sTable = sTable + "<td>" + data[i][j] + "</td>";
                                            }
                                            sTable = sTable + "</tr>";
                                        }
                                        sTable = sTable + "</table>";
                                        $("#SuccessTable").html(sTable);
                                        $("#LeadDataTable").css({ "width": "100%" });
                                        $("#LeadDataTable").dataTable();
                                        $("#MailData").html("Data Saved Successfully");
                                        $("#MailData").dialog({
                                            autoOpen: true,
                                            modal: true,
                                            title: 'Mail Data',
                                            width: 300,
                                            buttons: {
                                                Ok: function () {
                                                    $(this).dialog("close"); //closing on Ok click
                                                },
                                            },

                                        });
                                    }

                                    $.unblockUI();
                                }
                            });
                            $(this).dialog("close"); //closing on Ok click
                        },
                        Cancel: function () {
                            $(this).dialog("close"); //closing on Ok click
                        }
                    },

                });
                $.unblockUI();
            }
        });
    });

    $(document).ready(function () {
        $('#MailID').change(function () {
            var ID = $('#MailID :selected').val();
            if (ID.length > 0) {
                var EmailID = $('#MailID :selected').text();
                var sValues = { ID: ID };
                $('.EMailID').html(EmailID);
                $.blockUI({ message: '<h3 class="nh3"><img src="@PhysicalPath/Scripts/ckfinder/plugins/gallery/colorbox/images/loading.gif" width="50px" /> Please wait while Loading folders...</h3>' });
                //$("#MailData").dialog({ autoOpen: false });
                $.ajax({
                    url: '@Url.Action("SelectFoldersWithIMAP", "Mail")',
                    type: 'POST',
                    datatype: 'JSON',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(sValues),
                    cache: false,
                    success: function (data) {
                        //$("#FolderList").append("<button style='background-color: #DC143C;color:#FFFAF0;' id='createemail' type='submit' value='Compose'>Compose</button>");
                        //$("#FolderList").append(" <h3>Folders</h3>");
                        $("#FolderList").html('');
                        $("#SubjectList").html('');
                        $('#SuccessTable').empty();
                        for (i = 0; i < data.length; i++) {
                            $("#FolderList").append("<button type='submit' id='folderName' class='btn folders' value='" + data[i] + "'>" + data[i] + "</button><br/>");
                        }
                        $.unblockUI();
                    }
                });
            }
            else {
                $("#FolderList").html('');
                $("#SubjectList").html('');
                $('.EMailID').html('');
                $('#SuccessTable').empty();
            }

        });
    });
</script>
<script>
    $(".maillist").click(function () {
        $("#FolderList").toggleClass("leftzero");
    });
</script>

<script>
    $("#FolderList").click(function () {
        $("#FolderList").removeClass("leftzero");
    });
</script>